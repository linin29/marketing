<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tunicorn.marketing.mapper.AdminServiceApplyMapper">
	<resultMap id="AdminServiceApplyResultMap" type="com.tunicorn.marketing.vo.AdminServiceApplyVO">
		<result column="id" property="id" jdbcType="INTEGER" />
		<result column="user_id" property="userId" jdbcType="INTEGER" />
		<result column="username" property="username" jdbcType="VARCHAR" />
		<result column="email" property="email" jdbcType="VARCHAR" />
		<result column="reject_reason" property="rejectReason" jdbcType="VARCHAR" />
		<result column="app_business_name" property="appBusinessName" jdbcType="VARCHAR" />
		<result column="app_business_address" property="appBusinessAddress" jdbcType="VARCHAR" />
		<result column="app_business_mobile" property="appBusinessMobile" jdbcType="VARCHAR" />
		<result column="app_business_contacts" property="appBusinessContacts" jdbcType="VARCHAR" />
		<result column="max_call_number" property="maxCallNumber" jdbcType="INTEGER" />
		<result column="creator_id" property="creatorId" jdbcType="INTEGER" />
		<result column="apply_status" property="applyStatus" jdbcType="VARCHAR" />
		<result column="create_time" property="createTime" javaType="java.sql.Timestamp" jdbcType="TIMESTAMP" />
		<result column="last_update" property="lastUpdate" javaType="java.sql.Date" jdbcType="TIMESTAMP" />
		<result column="status" property="status" jdbcType="VARCHAR" />
		<collection property="majorTypes" ofType="com.tunicorn.marketing.vo.MajorTypeVO">
        	<result column="major_type_id" property="id" jdbcType="INTEGER"/>
        	<result column="major_type_name" property="name" jdbcType="VARCHAR"/>
        </collection>
        <collection property="creator" ofType="com.tunicorn.marketing.vo.UserVO">
        	<result column="creatorId" property="id" jdbcType="INTEGER"/>
        	<result column="creatorName" property="name" jdbcType="VARCHAR"/>
        </collection>
	</resultMap>
 
   <insert id="createAdminServiceApply" parameterType="com.tunicorn.marketing.vo.AdminServiceApplyVO" useGeneratedKeys="true"  keyProperty="id">
    insert into admin_service_apply
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="userId != null" >
        user_id,
      </if>
      <if test="username != null" >
        username,
      </if>
       <if test="email != null" >
        email,
      </if>
      <if test="appBusinessName != null" >
        app_business_name,
      </if>
      <if test="appBusinessAddress != null" >
        app_business_address,
      </if>
       <if test="appBusinessMobile != null" >
        app_business_mobile,
      </if>
       <if test="appBusinessContacts != null" >
        app_business_contacts,
      </if>
      <if test="maxCallNumber != null" >
        max_call_number,
      </if>
      <if test="creatorId != null" >
        creator_id,
      </if>
       <if test="applyStatus != null" >
        apply_status,
      </if>
        create_time,
      <if test="lastUpdate != null" >
        last_update,
      </if>

    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="userId != null" >
        #{userId,jdbcType=INTEGER},
      </if>
      <if test="username != null" >
        #{username, jdbcType=INTEGER},
      </if>
     <if test="email != null" >
        #{email, jdbcType=INTEGER},
      </if>
      <if test="appBusinessName != null" >
        #{appBusinessName,jdbcType=VARCHAR},
      </if>
      <if test="appBusinessAddress != null" >
        #{appBusinessAddress,jdbcType=VARCHAR},
      </if>
      <if test="appBusinessMobile != null" >
        #{appBusinessMobile,jdbcType=VARCHAR},
      </if>
      <if test="appBusinessContacts != null" >
        #{appBusinessContacts,jdbcType=VARCHAR},
      </if>
      <if test="maxCallNumber != null" >
        #{maxCallNumber,jdbcType=INTEGER},
      </if>
      <if test="creatorId != null" >
        #{creatorId,jdbcType=INTEGER},
      </if>
       <if test="applyStatus != null" >
        #{applyStatus,jdbcType=VARCHAR},
      </if>
        now(),
      <if test="lastUpdate!= null" >
        #{lastUpdate,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
	<select id="getAdminServiceApplyList" resultMap="AdminServiceApplyResultMap" parameterType="com.tunicorn.marketing.bo.AdminServiceApplyBO">
		select asa.id,  asa.user_id, asa.app_business_name, asa.app_business_address, asa.app_business_mobile, asa.app_business_contacts,
		asa.max_call_number, asa.creator_id, asa.apply_status, asa.create_time, asa.last_update, mt.name as major_type_name, mt.id as major_type_id,
		au.name as creatorName, asa.username, asa.email, asa.reject_reason
		from admin_service_apply asa 
		left join admin_major_type_service_apply_mapping amt on asa.id = amt.service_apply_id
		left join major_type mt  on mt.id = amt.major_type_id
		left join admin_user au on au.id=asa.creator_id
		where asa.`status` = 'active'
		<if test="applyStatus != null and applyStatus != ''">
			and asa.apply_status = #{applyStatus}
		</if>
		<if test="appBusinessName != null and appBusinessName != ''">
			and asa.app_business_name like concat(concat('%',#{appBusinessName}),'%')
		</if>
		order by create_time desc
		limit #{startNum}, #{perPage}
	</select>
	<select id="getAdminServiceApplyCount" resultType="int" parameterType="com.tunicorn.marketing.bo.AdminServiceApplyBO">
		select count(*)
		from admin_service_apply
		where `status` = 'active'
	    <if test="applyStatus != null and applyStatus != ''">
			and apply_status = #{applyStatus}
		</if>
		<if test="appBusinessName != null and appBusinessName != ''">
			and app_business_name like concat(concat('%',#{appBusinessName}),'%')
		</if>
	</select>
	<update id="updateAdminServiceApply" parameterType="com.tunicorn.marketing.vo.AdminServiceApplyVO">
		UPDATE admin_service_apply
		<trim prefix="set" suffixOverrides=",">
			<if test="appBusinessName != null and appBusinessName !=''">
				app_business_name=#{appBusinessName},
			</if>
			<if test="appBusinessAddress != null and appBusinessAddress !=''">
				app_business_address=#{appBusinessAddress},
			</if>
			<if test="appBusinessMobile != null and appBusinessMobile !=''">
				app_business_mobile=#{appBusinessMobile},
			</if>
			<if test="appBusinessContacts != null and appBusinessContacts !=''">
				app_business_contacts=#{appBusinessContacts},
			</if>
			<if test="maxCallNumber != null and maxCallNumber !=''">
				max_call_number=#{maxCallNumber},
			</if>
			<if test="applyStatus != null and applyStatus !=''">
				apply_status=#{applyStatus},
			</if>
			<if test="status != null and status !=''">
				`status` = #{status},
			</if>
			<if test="username != null and username !=''">
				`username` = #{username},
			</if>
			<if test="email != null and email !=''">
				`email` = #{email},
			</if>
			<if test="rejectReason != null and rejectReason !=''">
				reject_reason = #{rejectReason},
			</if>
		</trim>
		WHERE id=#{id}
	</update>
	<update id="updateMajorTypeApplicationMapping" parameterType="com.tunicorn.marketing.vo.MajorTypeApplicationMappingVO">
		UPDATE major_type_application_mapping
		<trim prefix="set" suffixOverrides=",">
			<if test="maxCallNumber != null and maxCallNumber !=''">
				max_call_number=#{maxCallNumber},
			</if>
			<if test="applyStatus != null and applyStatus !=''">
				apply_status=#{applyStatus},
			</if>
			<if test="status != null and status !=''">
				`status`=#{status},
			</if>
		</trim>
		WHERE id=#{id}
	</update>
	<select id="getAdminServiceApplyById" resultMap="AdminServiceApplyResultMap" parameterType="int">
		select asa.id,  asa.user_id, asa.app_business_name, asa.app_business_address, asa.app_business_mobile, asa.app_business_contacts,
		asa.max_call_number, asa.creator_id, asa.apply_status, asa.create_time, asa.last_update, mt.name as major_type_name, mt.id as major_type_id,
		asa.username, asa.email, asa.reject_reason
		from admin_service_apply asa 
		left join admin_major_type_service_apply_mapping amt on asa.id = amt.service_apply_id
		left join major_type mt  on mt.id = amt.major_type_id
		where asa.`status` = 'active'
	    <if test="id != null and id != ''">
			and asa.id = #{id}
		</if>
	</select>
</mapper>

