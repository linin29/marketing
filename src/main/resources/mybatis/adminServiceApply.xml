<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tunicorn.marketing.mapper.AdminServiceApplyMapper">
	<resultMap id="AdminServiceApplyResultMap" type="com.tunicorn.marketing.vo.AdminServiceApplyVO">
		<result column="id" property="id" jdbcType="INTEGER" />
		<result column="user_id" property="userId" jdbcType="INTEGER" />
		<result column="username" property="username" jdbcType="VARCHAR" />
		<result column="email" property="email" jdbcType="VARCHAR" />
		<result column="reject_reason" property="rejectReason" jdbcType="VARCHAR" />
		<result column="max_call_number" property="maxCallNumber" jdbcType="INTEGER" />
		<result column="creator_id" property="creatorId" jdbcType="INTEGER" />
		<result column="project_id" property="projectId" jdbcType="VARCHAR" />
		<result column="start_time" property="startTime" javaType="java.sql.Timestamp" jdbcType="TIMESTAMP"/>
		<result column="end_time" property="endTime" javaType="java.sql.Timestamp" jdbcType="TIMESTAMP"/>
		<result column="apply_status" property="applyStatus" jdbcType="VARCHAR" />
		<result column="create_time" property="createTime" javaType="java.sql.Timestamp" jdbcType="TIMESTAMP" />
		<result column="last_update" property="lastUpdate" javaType="java.sql.Date" jdbcType="TIMESTAMP" />
		<result column="status" property="status" jdbcType="VARCHAR" />
		<collection property="majorTypes" ofType="com.tunicorn.marketing.vo.MajorTypeVO">
        	<result column="major_type_id" property="id" jdbcType="INTEGER"/>
        	<result column="major_type_name" property="name" jdbcType="VARCHAR"/>
        </collection>
        <collection property="creator" ofType="com.tunicorn.marketing.vo.UserVO">
        	<result column="creatorId" property="id" jdbcType="INTEGER"/>
        	<result column="creatorName" property="name" jdbcType="VARCHAR"/>
        </collection>
	</resultMap>
 
   <insert id="createAdminServiceApply" parameterType="com.tunicorn.marketing.vo.AdminServiceApplyVO" useGeneratedKeys="true"  keyProperty="id">
    insert into admin_service_apply
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="userId != null" >
        user_id,
      </if>
      <if test="username != null" >
        username,
      </if>
       <if test="email != null" >
        email,
      </if>
      <if test="maxCallNumber != null" >
        max_call_number,
      </if>
      <if test="creatorId != null" >
        creator_id,
      </if>
       <if test="projectId != null" >
        project_id,
      </if>
      <if test="startTime != null" >
        start_time,
      </if>
      <if test="endTime != null" >
        end_time,
      </if>
       <if test="applyStatus != null" >
        apply_status,
      </if>
        create_time,
      <if test="lastUpdate != null" >
        last_update,
      </if>

    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="userId != null" >
        #{userId,jdbcType=INTEGER},
      </if>
      <if test="username != null" >
        #{username, jdbcType=INTEGER},
      </if>
     <if test="email != null" >
        #{email, jdbcType=INTEGER},
      </if>
      <if test="maxCallNumber != null" >
        #{maxCallNumber,jdbcType=INTEGER},
      </if>
      <if test="creatorId != null" >
        #{creatorId,jdbcType=INTEGER},
      </if>
      <if test="projectId != null" >
        #{projectId,jdbcType=VARCHAR},
      </if>
      <if test="startTime != null" >
        #{projectId,jdbcType=TIMESTAMP},
      </if>
      <if test="endTime != null" >
        #{endTime,jdbcType=TIMESTAMP},
      </if>
       <if test="applyStatus != null" >
        #{applyStatus,jdbcType=VARCHAR},
      </if>
        now(),
      <if test="lastUpdate!= null" >
        #{lastUpdate,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
	<select id="getAdminServiceApplyList" resultMap="AdminServiceApplyResultMap" parameterType="com.tunicorn.marketing.bo.AdminServiceApplyBO">
		select asa.id,  asa.user_id,
		asa.max_call_number, asa.creator_id, asa.apply_status, asa.create_time, asa.last_update, mt.name as major_type_name, mt.id as major_type_id,
		au.name as creatorName, asa.username, asa.email, asa.reject_reason
		from 
		(select id,  user_id,
			max_call_number, creator_id, apply_status, create_time, last_update, username, email, reject_reason, `status`
        	from admin_service_apply where `status` = 'active'
        	<if test="applyStatus != null and applyStatus != ''">
				and apply_status = #{applyStatus}
			</if>
       	 	order by create_time desc
			limit #{startNum}, #{perPage}
        )asa,admin_major_type_service_apply_mapping am,major_type mt,admin_user au
		where asa.`status` = 'active'
		and asa.id=am.service_apply_id and am.`status`='active'
        and mt.id=am.major_type_id and mt.`status`='active'
        and au.id=asa.creator_id and au.`status`='active'
	</select>
	<select id="getAdminServiceApplyCount" resultType="int" parameterType="com.tunicorn.marketing.bo.AdminServiceApplyBO">
		select count(*)
		from admin_service_apply
		where `status` = 'active'
	    <if test="applyStatus != null and applyStatus != ''">
			and apply_status = #{applyStatus}
		</if>
	</select>
	<update id="updateAdminServiceApply" parameterType="com.tunicorn.marketing.vo.AdminServiceApplyVO">
		UPDATE admin_service_apply
		<trim prefix="set" suffixOverrides=",">
			<if test="maxCallNumber != null and maxCallNumber !=''">
				max_call_number=#{maxCallNumber},
			</if>
			<if test="applyStatus != null and applyStatus !=''">
				apply_status=#{applyStatus},
			</if>
			<if test="status != null and status !=''">
				`status` = #{status},
			</if>
			<if test="username != null and username !=''">
				`username` = #{username},
			</if>
			<if test="email != null and email !=''">
				`email` = #{email},
			</if>
			<if test="startTime != null and startTime !=''">
				`start_time` = #{startTime},
			</if>
			<if test="endTime != null and endTime !=''">
				`end_time` = #{endTime},
			</if>
				reject_reason = #{rejectReason},
		</trim>
		WHERE id=#{id}
	</update>
	<update id="updateMajorTypeApplicationMapping" parameterType="com.tunicorn.marketing.vo.MajorTypeApplicationMappingVO">
		UPDATE major_type_application_mapping
		<trim prefix="set" suffixOverrides=",">
			<if test="maxCallNumber != null and maxCallNumber !=''">
				max_call_number=#{maxCallNumber},
			</if>
			<if test="applyStatus != null and applyStatus !=''">
				apply_status=#{applyStatus},
			</if>
			<if test="status != null and status !=''">
				`status`=#{status},
			</if>
		</trim>
		WHERE id=#{id}
	</update>
	<select id="getAdminServiceApplyById" resultMap="AdminServiceApplyResultMap" parameterType="int">
		select asa.id,  asa.user_id,
		asa.max_call_number, asa.creator_id, asa.apply_status, asa.create_time, asa.last_update, mt.name as major_type_name, mt.id as major_type_id,
		asa.username, asa.email, asa.reject_reason
		from admin_service_apply asa 
		left join admin_major_type_service_apply_mapping amt on asa.id = amt.service_apply_id
		left join major_type mt  on mt.id = amt.major_type_id
		where asa.`status` = 'active'
	    <if test="id != null and id != ''">
			and asa.id = #{id}
		</if>
	</select>
</mapper>

